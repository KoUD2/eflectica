<%
  set_meta_tags(
    title: "Эффекты",
    description: "Все самые лучшие эффекты на Eflectica",
    keywords: "эффекты, пресеты"
  )
%>

<% content_for :title, "Effects" %>

<div class='Q_Section Q_SectionActive'>
  <div class='O_Prewiew'>
    <div class='O_Card'>
      <div class="A_TextM A_TextMCard"><p>Подписки</p></div>
      <div class="A_TextL"><p>Сохраняй чужие коллекции полезных пресетов</p></div>
    </div>
    <%= image_tag("line1.svg", alt: "Картинка", class: "Q_Line1") %>
    <div class='O_Card O_CardSimple O_Card4'>
      <p>Находи вдохновение и бесплатные пресеты для проектов</p>
    </div>
    <div class='O_Card O_CardMedium O_CardMediumRed2'>
      <div class="A_TextM A_TextMCard A_TextMRed"><p>Эффекты</p></div>
      <div class="A_TextL"><p>Удобно сортируй эффекты по&nbsp;категориям, задачам и&nbsp;программам</p></div>
    </div>
    <%= image_tag("line2.svg", alt: "Картинка", class: "Q_Line2") %>
    <%= image_tag("MainLogo.svg", alt: "Картинка", class: "A_MainLogo") %>
    <div class='O_Card O_CardSimple O_Card3'>
      <p>Следи за модными трендами в&nbsp;индустрии и сохраняй их</p>
    </div>
    <div class='O_Card O_CardMedium O_CardMediumRed'>
      <div class="A_TextM A_TextMCard A_TextMRed"><p>Мои коллекции</p></div>
      <div class="A_TextL"><p>Сохраняй референсы, туториалы и эффекты в одном месте</p></div>
    </div>
    <%= image_tag("line3.svg", alt: "Картинка", class: "Q_Line3") %>
    <div class='O_Card O_CardProfile'>
      <div class="A_TextM A_TextMCard"><p>Профиль</p></div>
      <div class="A_TextL"><p>Создавай портфолио, пополняя сайт своими эффектами</p></div>
    </div>
    <%= image_tag("line4.svg", alt: "Картинка", class: "Q_Line4") %>
    <div class='O_Card O_CardSimple O_Card2'>
      <p>Кастомизируй свою ленту и развивай сообщество</p>
    </div>
  </div>

  <div class='M_aboutEffects'>
    <div class="W_allEffectsMobile">
      <h1 class='A_Header1'>Трендовые эффекты</h1>
      <%= link_to trending_effects_path do %>
        <button class='A_More A_MoreMobile'>Смотреть все</button>
      <% end %>
    </div>
    <div class='W_allEffects'>
      <p class='A_TextEffectDescription'>Если хочется создать контент, который залетит в&nbsp;тренды, посмотри новинки в&nbsp;этом разделе</p>
      <%= link_to trending_effects_path do %>
        <button class='A_More A_MorePC'>Смотреть все</button>
      <% end %>
    </div>
  </div>

  <div class='Q_FavoriteSection'>
    <div class="W_Effects">
      <div class="C_Effects">
        <% @effects.first(3).each do |effect| %>
          <%= render partial: "effects/effect", locals: { effect: effect } %>
        <% end %>
      </div>
      <div class="C_Effects">
        <% @effects.offset(3).first(3).each do |effect| %>
          <%= render partial: "effects/effect", locals: { effect: effect } %>
        <% end %>
      </div>
    </div>

    <div class='Q_Particle'></div>
    <div class='Q_Particle'></div>
    <div class='Q_Particle'></div>
    <div class='Q_Particle'></div>
    <div class='Q_Particle'></div>
    <div class='Q_Particle'></div>
  </div>
</div>

<div class='W_categoriesCreatePost'>
  <div class="W_allSectionsMain">
    <div class='O_allCategories' data-controller="category-filter">
      <div class='M_aboutEffects'>
        <div class='W_allCategories'>
          <h1 class='A_Header1'>Категории</h1>
          <%= link_to categories_effects_path do %>
            <button class='A_More'>
              Больше категорий
              <%= image_tag("ArrowIcon.svg", alt: "Картинка рейтинга", class: "Q_arrowFollow") %>
            </button>
          <% end %>
        </div>
        <p class='A_TextEffectDescription'>Выбери направление, в&nbsp;котором работаешь. Это&nbsp;поможет найти нужный эффект</p>
      </div>

      <div class='W_searchInfo W_searchInfoFeed'>
        <div class='W_inputIcon' data-controller="search-effects">
          <input type="text" class='A_searchInput' placeholder='Поиск' 
                 data-search-effects-target="input" 
                 data-action="input->search-effects#search">
          <%= image_tag("Q_IconSearch.svg", alt: "Картинка рейтинга", class: "Q_IconSearch") %>
        </div>
        <div class="Q_FilterDropdown">
          <button class='A_FilterSearch' data-action="category-filter#toggle" data-category-filter-target="toggleButton">
            <p>Где искать</p>
            <%= image_tag("Q_IconArrowBlack.svg", alt: "Картинка рейтинга", class: "Q_IconArrowBlack") %>
          </button>
          <div class="Q_CategoryDropdown" data-category-filter-target="dropdown" style="display: none;">
            <div class="Q_CategoryList">
              <label class="Q_CategoryItem custom-checkbox">
                <span>Обработка фото</span>
                <input type="checkbox" value="photoProcessing" data-action="category-filter#filterEffects">
                <span class="checkmark"></span>
              </label>
              <label class="Q_CategoryItem custom-checkbox">
                <span>3D-графика</span>
                <input type="checkbox" value="3dGrafics" data-action="category-filter#filterEffects">
                <span class="checkmark"></span>
              </label>
              <label class="Q_CategoryItem custom-checkbox">
                <span>Моушен</span>
                <input type="checkbox" value="motion" data-action="category-filter#filterEffects">
                <span class="checkmark"></span>
              </label>
              <label class="Q_CategoryItem custom-checkbox">
                <span>Иллюстрация</span>
                <input type="checkbox" value="illustration" data-action="category-filter#filterEffects">
                <span class="checkmark"></span>
              </label>
              <label class="Q_CategoryItem custom-checkbox">
                <span>Анимация</span>
                <input type="checkbox" value="animation" data-action="category-filter#filterEffects">
                <span class="checkmark"></span>
              </label>
              <label class="Q_CategoryItem custom-checkbox">
                <span>UI/UX-анимация</span>
                <input type="checkbox" value="uiux" data-action="category-filter#filterEffects">
                <span class="checkmark"></span>
              </label>
              <label class="Q_CategoryItem custom-checkbox">
                <span>Обработка видео</span>
                <input type="checkbox" value="videoProcessing" data-action="category-filter#filterEffects">
                <span class="checkmark"></span>
              </label>
              <label class="Q_CategoryItem custom-checkbox">
                <span>VFX</span>
                <input type="checkbox" value="vfx" data-action="category-filter#filterEffects">
                <span class="checkmark"></span>
              </label>
              <label class="Q_CategoryItem custom-checkbox">
                <span>Геймдев</span>
                <input type="checkbox" value="gamedev" data-action="category-filter#filterEffects">
                <span class="checkmark"></span>
              </label>
              <label class="Q_CategoryItem custom-checkbox">
                <span>AR & VR</span>
                <input type="checkbox" value="arvr" data-action="category-filter#filterEffects">
                <span class="checkmark"></span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class='O_Effects' data-category="photoProcessing" data-category-filter-target="effectSection">
        <div class="M_HeaderEffects">
          <h2 class="A_Header2">Обработка фото</h2>
          <button class='A_buttonWatchAll'>Смотреть все</button>
        </div>
        <div class="C_Effects">
          <% @effects.select { |effect| effect.categories.pluck(:name).include?('photoProcessing') }.first(3).each do |effect| %>
            <%= render partial: "effects/collection_effect", locals: { effect: effect } %>
          <% end %>
        </div>
      </div>

      <div class='O_Effects' data-category="3dGrafics" data-category-filter-target="effectSection">
        <div class="M_HeaderEffects">
          <h2 class="A_Header2">3D-графика</h2>
          <button class='A_buttonWatchAll'>Смотреть все</button>
        </div>
        <div class="C_Effects">
          <% @effects.select { |effect| effect.categories.pluck(:name).include?('3dGrafics') }.first(3).each do |effect| %>
            <%= render partial: "effects/collection_effect", locals: { effect: effect } %>
          <% end %>
        </div>
      </div>

      <div class='O_Effects' data-category="motion" data-category-filter-target="effectSection">
        <div class="M_HeaderEffects">
          <h2 class="A_Header2">Моушен</h2>
          <button class='A_buttonWatchAll'>Смотреть все</button>
        </div>
        <div class="C_Effects">
          <% @effects.select { |effect| effect.categories.pluck(:name).include?('motion') }.first(3).each do |effect| %>
            <%= render partial: "effects/collection_effect", locals: { effect: effect } %>
          <% end %>
        </div>
      </div>
      <div class='O_Effects' data-category="illustration" data-category-filter-target="effectSection" style="display: none;">
        <div class="M_HeaderEffects">
          <h2 class="A_Header2">Иллюстрация</h2>
          <button class='A_buttonWatchAll'>Смотреть все</button>
        </div>
        <div class="C_Effects">
          <% @effects.select { |effect| effect.categories.pluck(:name).include?('illustration') }.first(3).each do |effect| %>
            <%= render partial: "effects/collection_effect", locals: { effect: effect } %>
          <% end %>
        </div>
      </div>

      <div class='O_Effects' data-category="animation" data-category-filter-target="effectSection" style="display: none;">
        <div class="M_HeaderEffects">
          <h2 class="A_Header2">Анимация</h2>
          <button class='A_buttonWatchAll'>Смотреть все</button>
        </div>
        <div class="C_Effects">
          <% @effects.select { |effect| effect.categories.pluck(:name).include?('animation') }.first(3).each do |effect| %>
            <%= render partial: "effects/collection_effect", locals: { effect: effect } %>
          <% end %>
        </div>
      </div>

      <div class='O_Effects' data-category="vfx" data-category-filter-target="effectSection" style="display: none;">
        <div class="M_HeaderEffects">
          <h2 class="A_Header2">VFX</h2>
          <button class='A_buttonWatchAll'>Смотреть все</button>
        </div>
        <div class="C_Effects">
          <% vfx_effects = @effects.select { |effect| effect.categories.pluck(:name).include?('vfx') }.first(3) %>
          <% if vfx_effects.empty? %>
            <p style="color: red; font-weight: bold;">Нет эффектов с категорией VFX! Всего эффектов: <%= @effects.count %></p>
            <p style="color: blue;">Категории первых 3 эффектов:</p>
            <% @effects.first(3).each_with_index do |effect, index| %>
              <p style="color: blue;">Эффект <%= index + 1 %>: <%= effect.name %> - категории: <%= effect.categories.pluck(:name).join(', ') %></p>
            <% end %>
          <% else %>
            <% vfx_effects.each do |effect| %>
              <%= render partial: "effects/collection_effect", locals: { effect: effect } %>
            <% end %>
          <% end %>
        </div>
      </div>

      <div class='O_Effects' data-category="uiux" data-category-filter-target="effectSection" style="display: none;">
        <div class="M_HeaderEffects">
          <h2 class="A_Header2">UI/UX-анимация</h2>
          <button class='A_buttonWatchAll'>Смотреть все</button>
        </div>
        <div class="C_Effects">
          <% @effects.select { |effect| effect.categories.pluck(:name).include?('uiux') }.first(3).each do |effect| %>
            <%= render partial: "effects/collection_effect", locals: { effect: effect } %>
          <% end %>
        </div>
      </div>

      <div class='O_Effects' data-category="videoProcessing" data-category-filter-target="effectSection" style="display: none;">
        <div class="M_HeaderEffects">
          <h2 class="A_Header2">Обработка видео</h2>
          <button class='A_buttonWatchAll'>Смотреть все</button>
        </div>
        <div class="C_Effects">
          <% @effects.select { |effect| effect.categories.pluck(:name).include?('videoProcessing') }.first(3).each do |effect| %>
            <%= render partial: "effects/collection_effect", locals: { effect: effect } %>
          <% end %>
        </div>
      </div>

      <div class='O_Effects' data-category="gamedev" data-category-filter-target="effectSection" style="display: none;">
        <div class="M_HeaderEffects">
          <h2 class="A_Header2">Геймдев</h2>
          <button class='A_buttonWatchAll'>Смотреть все</button>
        </div>
        <div class="C_Effects">
          <% @effects.select { |effect| effect.categories.pluck(:name).include?('gamedev') }.first(3).each do |effect| %>
            <%= render partial: "effects/collection_effect", locals: { effect: effect } %>
          <% end %>
        </div>
      </div>

      <div class='O_Effects' data-category="arvr" data-category-filter-target="effectSection" style="display: none;">
        <div class="M_HeaderEffects">
          <h2 class="A_Header2">AR & VR</h2>
          <button class='A_buttonWatchAll'>Смотреть все</button>
        </div>
        <div class="C_Effects">
          <% @effects.select { |effect| effect.categories.pluck(:name).include?('arvr') }.first(3).each do |effect| %>
            <%= render partial: "effects/collection_effect", locals: { effect: effect } %>
          <% end %>
        </div>
      </div>
    </div>

    <div class='M_createPostCard M_createPostCardMobile'>
    <h2 class="A_Header2"><span>Поделись эффектом,</span> чтобы улучшить портфолио и развивать свое сообщество</h2>
    <div class='W_raitingCreateEffect'>
      <p class='A_raitingCreateEffectTitle'>Рейтинг</p>
      <div class='W_raitingCountCreateEffect'>
        <%= image_tag("Q_StarIcon.svg", alt: "Картинка рейтинга", class: "Q_StarIconCreateEffect") %>
        <p class='A_raitingCountCreateEffect'>4.8</p>
      </div>
      <p class='A_feedbackCounttCreateEffect'>На основе 182 оценок</p>
    </div>
    <%= image_tag("GlassPhotography.png", alt: "Картинка рейтинга", class: "Q_pictureCreateEffect") %>

    <div data-controller="effect-create" id="mobile_effect_form">
      <button class="A_ButtonPrimary A_ButtonPrimaryCreate" data-action="effect-create#open" type="button">Написать пост</button>
      <!-- , scope: :effect -->
      <%= form_with model: @effect, url: effects_path do |f| %>
        <dialog class="modal modalEffect" data-effect-create-target="dialog" id="mobile-effect-dialog">
          <button type="button" style="position: absolute; top: 10px; right: 10px; background: #f00; color: white; z-index: 9999;" 
                  onclick="
                    console.log('--- DEBUG INFO ---');
                    console.log('Current active step:', document.querySelector('.A_TextTagFeedActive')?.textContent.trim());
                    console.log('All data-effect-create-target elements:');
                    document.querySelectorAll('[data-effect-create-target]').forEach(el => {
                      console.log(`Element: ${el.getAttribute('data-effect-create-target')}, Display: ${window.getComputedStyle(el).display}, Visible: ${el.offsetParent !== null}`);
                    });
                  ">
            Debug
          </button>
          <div class="modal-content2">
            <div class="A_HeaderChoice">
              <h3 class="A_Header3">Создание коллекции</h3>
              <button type="button" class="modal-close" data-action="effect-create#close">
                <%= image_tag("Q_IconClose.svg", alt: "Картинка", class: "Q_IconClose") %>
              </button>
            </div>
            <div class="M_ProgressBar">
              <div class="W_ProgressContainer">
                <div class="W_ProgressLine">
                  <div class="Q_ProgressFill" data-effect-create-target="progressBar" style="width: 20%;"></div>
                </div>
              </div>
            </div>
            <div class='O_CreateEffectInfo'>
              <div class='O_EffectInfo' data-effect-create-target="effectInfo">
                <div class='M_CollectionForm'>
                  <%= f.text_field :name, 
                  class: "A_InputForm", 
                  placeholder: 'Название эффекта',
                  data: { effect_create_target: "effectName", action: "input->effect-create#updatePreviewText" } %>
                  <%= f.text_area :description, 
                   class: 'A_InputForm A_InputFormTextArea', 
                   placeholder: 'Описание эффекта' %>
                </div>
                <div class='W_PhotoChoice'>
                  <div class='M_PhotoDescription'>
                    <h3 class="A_Header3">Фото</h3>
                    <p class="A_TextTag A_TextTagBig A_TextTagLight">Из этих фотографий создается обложка эффекта. Минимальный размер фото — 1024×1024</p>
                  </div>
    
                  <div class='С_PhotoGalleryEffectPreview'>
                    <div class='M_PhotoElementPreview'>
                      <div class="M_PhotoElementLabel">
                        <%= f.file_field :image_before, 
                            accept: "image/*,.gif", 
                            class: "M_PhotoElementInput", 
                            id: "image_before_field_mobile",
                            data: { effect_create_target: "inputBefore", action: "change->effect-create#previewImage" },
                            hidden: true %>
                        <label for="image_before_field_mobile" class="file-label" style="cursor: pointer; display: block; width: 100%; height: 100%;">
                          <div class="M_PhotoElementPreviewImage">
                            <%= image_tag("icon-attachment.svg", alt: "Иконка файла", class: "file-icon", data: { effect_create_target: "outputBefore" }) %>
                          </div>
                        </label>
                      </div>
                      <p class='A_TextTag A_TextTagBig A_TextTagLight'>До применения</p>
                    </div>
                    <div class='M_PhotoElementPreview'>
                      <div class="M_PhotoElementLabel">
                        <%= f.file_field :image_after, 
                            accept: "image/*,.gif", 
                            class: "M_PhotoElementInput", 
                            id: "image_after_field_mobile",
                            data: { effect_create_target: "inputAfter", action: "change->effect-create#previewImage" },
                            hidden: true %>
                        <label for="image_after_field_mobile" class="file-label" style="cursor: pointer; display: block; width: 100%; height: 100%;">
                          <div class="M_PhotoElementPreviewImage">
                            <%= image_tag("icon-attachment.svg", alt: "Иконка файла", class: "file-icon", data: { effect_create_target: "outputAfter" }) %>
                          </div>
                        </label>
                      </div>
                      <p class='A_TextTag A_TextTagBig A_TextTagLight'>После применения</p>
                    </div>
                  </div>                
                </div>
              </div>
              <div class='O_InstructionInfo' data-effect-create-target="instructionBlock" style="display: none;">
                <div class='M_CollectionForm'>
                  <p class="A_TextTag A_TextTagBig A_TextTagLight">Объясни, как импортировать эффект в программу или несколько программ. Опиши особенности использования и настройки эффекта</p>
                  <%= f.text_area :manual, 
                  class: 'A_InputForm A_InputFormTextArea A_InputFormTextAreaBig', 
                  placeholder: 'Инструкция по установке и настройке',
                  data: { effect_create_target: "instructionText" } %>
                </div>
              </div>
              <div class='W_PreviewArea' data-effect-create-target="previewArea">
                <h3 class="A_Header3">Превью</h3>
                <div class='O_EffectCardPreview O_EffectCardPreviewOver O_EffectCardPreviewSmall'>
                  <div class='С_PhotoGalleryEffectPreview'>
                    <div class='M_PhotoElement'>
                      <%= image_tag("emptyImage.svg", alt: "Картинка", class: "Q_emptyImage") %>
                    </div>
                    <div class='M_PhotoElement'>
                      <%= image_tag("emptyImage.svg", alt: "Картинка", class: "Q_emptyImage") %>
                    </div>
                  </div>
                  <p class='A_TextEffectCard A_TextEffectCardPreview' data-effect-create-target="previewText">Название</p>
                </div>
              </div>        
            </div>
            <div class='O_CategoriesInfo' data-effect-create-target="categoriesBlock" style="display: none;">
              <div class='M_CollectionForm'>
                <div class="M_CategoriesWrapper">
                  <h3 class="A_Header3">Категория</h3>
                  <%= f.hidden_field :programs, value: "blender" %>
                  <%= f.hidden_field :platform, id: "selected_platform" %>
                  <div class="M_CategoriesContainer">
                    <% Effect::ALLOWED_TAGS.each do |category| %>
                      <div class="M_Choice" data-controller="choice" data-action="click->choice#click">
                        <%= f.label "category_list_#{category}", human_readable_category(category), class: 'A_TextButtonSeсondary A_TextButtonSeсondaryBlack' %>
                        <%= f.radio_button :category_list, category %>
                      </div>
                    <% end %>
                  </div> 
                </div>
              </div>
            </div>
            <div class='O_TagsInfo' data-effect-create-target="tagsBlock" style="display: none;">
              <div class='M_CollectionForm'>
                <div class="O_CreateEffectTagsArea" data-controller="effect-tags">
                  <div class="O_TagsCreateEffect">
                    <h3 class="A_Header3">Теги</h3>
                    
                    <!-- Задачи -->
                    <div class="Q_FilterDropdown">
                      <button class='A_Filter A_FilterCategory A_TextTagBig' type="button" data-action="effect-tags#toggleTasks" data-effect-tags-target="taskToggleButton">
                        Задача
                        <%= image_tag("Q_IconArrowBlack.svg", alt: "Картинка рейтинга", class: "Q_IconArrowBlack") %>
                      </button>
                      
                      <!-- Контейнер для отображения выбранных задач -->
                      <div class="C_SelectedCategories" data-effect-tags-target="selectedTasks" style="display: none;">
                        <div class="Q_SelectedCategoriesList" data-effect-tags-target="selectedTasksList">
                          <!-- Выбранные задачи будут добавляться сюда динамически -->
                        </div>
                      </div>
                      
                      <div class="Q_CategoryDropdown" data-effect-tags-target="taskDropdown" style="display: none;">
                        <div class="Q_CategoryList">
                          <% TaskHelper::TASK_MAPPINGS.each do |task_key, task_label| %>
                            <label class="Q_CategoryItem custom-checkbox">
                              <span><%= task_label %></span>
                              <%= f.check_box "task_list_#{task_key}", { checked: false, data: { action: "effect-tags#selectTask" } }, task_key, "" %>
                              <span class="checkmark"></span>
                            </label>
                          <% end %>
                        </div>
                      </div>
                    </div>

                    <!-- Программы -->
                    <div class="Q_FilterDropdown">
                      <button class='A_Filter A_FilterCategory A_TextTagBig' type="button" data-action="effect-tags#togglePrograms" data-effect-tags-target="programToggleButton">
                        Программа
                        <%= image_tag("Q_IconArrowBlack.svg", alt: "Картинка рейтинга", class: "Q_IconArrowBlack") %>
                      </button>
                      
                      <!-- Контейнер для отображения выбранных программ -->
                      <div class="C_SelectedCategories" data-effect-tags-target="selectedPrograms" style="display: none;">
                        <div class="Q_SelectedCategoriesList" data-effect-tags-target="selectedProgramsList">
                          <!-- Выбранные программы будут добавляться сюда динамически -->
                        </div>
                      </div>
                      
                      <div class="Q_CategoryDropdown" data-effect-tags-target="programDropdown" style="display: none;">
                        <div class="Q_CategoryList">
                          <% [
                            ["photoshop", "Photoshop"],
                            ["lightroom", "Lightroom"],
                            ["after_effects", "After Effects"],
                            ["premiere_pro", "Premiere Pro"],
                            ["blender", "Blender"],
                            ["affinity_photo", "Affinity Photo"],
                            ["capture_one", "Capture One"],
                            ["maya", "Maya"],
                            ["cinema_4d", "Cinema 4D"],
                            ["3ds_max", "3ds Max"],
                            ["zbrush", "ZBrush"],
                            ["unreal", "Unreal Engine"],
                            ["davinci", "DaVinci Resolve"],
                            ["substance", "Substance Painter"],
                            ["protopie", "ProtoPie"],
                            ["krita", "Krita"],
                            ["sketch", "Sketch"],
                            ["animate", "Adobe Animate"],
                            ["figma", "Figma"],
                            ["clip", "Clip Studio Paint"],
                            ["nuke", "Nuke"],
                            ["fc", "Final Cut Pro"],
                            ["procreate", "Procreate"],
                            ["godot", "Godot"],
                            ["lens", "Lens Studio"],
                            ["rive", "Rive"],
                            ["unity", "Unity"],
                            ["spark", "Spark AR"],
                            ["spine", "Spine"],
                            ["toon", "Toon Boom Harmony"]
                          ].each do |program_key, program_label| %>
                            <label class="Q_CategoryItem custom-checkbox">
                              <div class="Q_ProgramItemContent">
                                <%= image_tag(program_icon(program_key), alt: program_label, class: "Q_ProgramIconDropdown") if program_icon(program_key) %>
                                <span><%= program_label %></span>
                              </div>
                              <%= f.check_box "program_list_#{program_key}", { checked: false, data: { action: "effect-tags#selectProgram" } }, program_key, "" %>
                              <span class="checkmark"></span>
                            </label>
                          <% end %>
                        </div>
                      </div>
                    </div>

                    <!-- Платформы -->
                    <div class="Q_FilterDropdown">
                      <button class='A_Filter A_FilterCategory A_TextTagBig' type="button" data-action="effect-tags#togglePlatforms" data-effect-tags-target="platformToggleButton">
                        Платформа
                        <%= image_tag("Q_IconArrowBlack.svg", alt: "Картинка рейтинга", class: "Q_IconArrowBlack") %>
                      </button>
                      
                      <!-- Контейнер для отображения выбранных платформ -->
                      <div class="C_SelectedCategories" data-effect-tags-target="selectedPlatforms" style="display: none;">
                        <div class="Q_SelectedCategoriesList" data-effect-tags-target="selectedPlatformsList">
                          <!-- Выбранные платформы будут добавляться сюда динамически -->
                        </div>
                      </div>
                      
                      <div class="Q_CategoryDropdown" data-effect-tags-target="platformDropdown" style="display: none;">
                        <div class="Q_CategoryList">
                          <% [
                            ["windows", "Windows"],
                            ["mac", "Mac"]
                          ].each do |platform_key, platform_label| %>
                            <label class="Q_CategoryItem custom-checkbox">
                              <span><%= platform_label %></span>
                              <%= f.check_box "platform_list_#{platform_key}", { checked: false, data: { action: "effect-tags#selectPlatform effect-create#validateCurrentStep" } }, platform_key, "" %>
                              <span class="checkmark"></span>
                            </label>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class='O_LinkPreviewInfo' data-effect-create-target="linkPreviewBlock" style="display: none;">
              <div class='M_CollectionForm'>
                <div class="C_LinkArea">
                  <h3 class="A_Header3">Ссылка на скачивание</h3>
                  <p class="A_TextTag A_TextTagBig A_TextTagLight">Добавь действительную ссылку на облако или репозиторий, где можно скачать эффект</p>
                  <div class='W_linkEffect'>
                    <%= f.text_field :link_to, 
                    class: 'A_InputForm A_InputFormLink', 
                    placeholder: "Ссылка", data: { action: "input->effect-create#validateCurrentStep" } %>
                    <%= image_tag("linkIcon.svg", alt: "Картинка рейтинга", class: "Q_linkIcon") %>
                  </div>
                </div>
                
                <div class='W_PreviewArea'>
                  <h3 class="A_Header3">Превью эффекта</h3>
                  <div class='O_EffectCardPreview O_EffectCardPreviewOver O_EffectCardPreviewSmall'>
                    <div class='С_PhotoGalleryEffectPreview'>
                      <div class='M_PhotoElement'>
                        <%= image_tag("emptyImage.svg", alt: "Картинка", class: "Q_emptyImage") %>
                      </div>
                      <div class='M_PhotoElement'>
                        <%= image_tag("emptyImage.svg", alt: "Картинка", class: "Q_emptyImage") %>
                      </div>
                    </div>
                    <p class='A_TextEffectCard A_TextEffectCardPreview' data-effect-create-target="previewText">Название</p>
                  </div>
                  <div class="M_ModerationMessage">
                    <div class="A_ModerationText">Твой эффект опубликуется, когда ссылка пройдет проверку модератором. Мы пришлем уведомление, когда это произойдет.</div>
                  </div>
                </div>
              </div>
            </div>
                        <%= f.button 'Далее', 
             class: "A_ButtonPrimary A_ButtonPrimaryPreview", 
             data: { effect_create_target: "nextButton", action: "effect-create#nextStep" },
             type: "button" %>
            <%= f.button 'Отправить', 
             class: "A_ButtonPrimary A_ButtonPrimaryPreview", 
             type: "submit",
             style: "display: none;",
             data: { final_submit: true } %>
          </div>
        </dialog>
      <% end %>
    </div>   
  </div>

    <div class='O_allCategories' data-search-collections-target="subscriptionsSection">
      <div class='M_aboutEffects'>
        <div class='W_allCategories'>
          <h1 class='A_Header1'>Коллекции и подписки</h1>
          <%= link_to news_feeds_path do %>
            <button class='A_More'>
              Больше коллекций
              <%= image_tag("ArrowIcon.svg", alt: "Картинка рейтинга", class: "Q_arrowFollow") %>
            </button>
          <% end %>
        </div>
        <p class='A_TextEffectDescription A_TextEffectDescriptionCollection'>Референсы, ссылки на туториалы и эффекты удобно собирать в коллекции. Ты можешь создавать свои коллекции или подписываться на чужие</p>
      </div>

      <div class='W_inputIcon W_searchInfoFeed' data-controller="search-collections">
        <input type="text" class='A_searchInput' placeholder='Поиск коллекций'
               data-search-collections-target="input" 
               data-action="input->search-collections#search">
        <%= image_tag("Q_IconSearch.svg", alt: "Картинка рейтинга", class: "Q_IconSearch") %>
      </div>

      <div class="W_allCollections" data-search-collections-target="subscriptionsContainer">
        <div class="C_Collections">
          <% @collections.first(3).each do |collection| %>
            <%= render partial: "collections/collection", locals: { collection: collection, css_classes: { 
            header: "A", 
            text: "A" 
            }} %>
          <% end %>
        </div>      
      
        <div class="C_Collections">
          <% @collections.offset(3).first(3).each do |collection| %>
            <%= render partial: "collections/collection", locals: { collection: collection, css_classes: { 
            header: "A", 
            text: "A" 
            }} %>
          <% end %>
        </div>      
      </div>
    </div>

    <% unless user_signed_in? %>
      <div class='W_registrationForm'>
        <%= render 'devise/registrations/registration_form' %>
        
        <%= image_tag("RegistrationFormImage1.png", alt: "Картинка", class: "Q_registrationFormImage1") %>
        <%= image_tag("RegistrationFormImage2.png", alt: "Картинка", class: "Q_registrationFormImage2") %>
        <%= image_tag("RegistrationFormImage3.png", alt: "Картинка", class: "Q_registrationFormImage3") %>
        <%= image_tag("RegistrationFormImage4.png", alt: "Картинка", class: "Q_registrationFormImage4") %>
        <%= image_tag("RegistrationFormImage5.png", alt: "Картинка", class: "Q_registrationFormImage5") %>
        <%= image_tag("RegistrationFormImage6.png", alt: "Картинка", class: "Q_registrationFormImage6") %>
      </div>
    <% end %>  
  </div>

  <div class='M_createPostCard M_createPostCardPC'>
    <h2 class="A_Header2"><span>Поделись эффектом,</span> чтобы улучшить портфолио и развивать свое сообщество</h2>
    <div class='W_raitingCreateEffect'>
      <p class='A_raitingCreateEffectTitle'>Рейтинг</p>
      <div class='W_raitingCountCreateEffect'>
        <%= image_tag("Q_StarIcon.svg", alt: "Картинка рейтинга", class: "Q_StarIconCreateEffect") %>
        <p class='A_raitingCountCreateEffect'>4.8</p>
      </div>
      <p class='A_feedbackCounttCreateEffect'>На основе 182 оценок</p>
    </div>
    <%= image_tag("GlassPhotography.png", alt: "Картинка рейтинга", class: "Q_pictureCreateEffect") %>

    <div data-controller="effect-create">
      <button class="A_ButtonPrimary A_ButtonPrimaryCreate" data-action="effect-create#open" type="button">Написать пост</button>
      <!-- , scope: :effect -->
      <%= form_with model: @effect, url: effects_path do |f| %>
        <dialog class="modal modalEffect" data-effect-create-target="dialog" id="desktop-effect-dialog">
          <div class="modal-content2">
            <div class="A_HeaderChoice">
              <h3 class="A_Header2">Создание эффекта</h3>
              <button type="button" class="modal-close" data-action="effect-create#close">
                <%= image_tag("Q_IconClose.svg", alt: "Картинка", class: "Q_IconClose") %>
              </button>
            </div>
            <div class="M_ProgressBar">
              <div class="W_ProgressContainer">
                <div class="W_ProgressLine">
                  <div class="Q_ProgressFill" data-effect-create-target="progressBar" style="width: 20%;"></div>
                </div>
              </div>
            </div>
            <div class='O_CreateEffectInfo'>
              <div class='O_EffectInfo' data-effect-create-target="effectInfo">
                <div class='M_CollectionForm'>
                  <h3 class="A_Header3">Описание эффекта</h3>
                  <%= f.text_field :name, 
                  class: "A_InputForm", 
                  placeholder: 'Название эффекта',
                  data: { effect_create_target: "effectName", action: "input->effect-create#updatePreviewName" } %>
                  <%= f.text_area :description, 
                   class: 'A_InputForm A_InputFormTextArea', 
                   placeholder: 'Описание эффекта',
                   data: { effect_create_target: "effectDescription", action: "input->effect-create#validateCurrentStep" } %>
                </div>
                <div class='W_PhotoChoice'>
                  <div class='M_PhotoDescription'>
                    <h3 class="A_Header3">Фото</h3>
                    <p class="A_TextTag A_TextTagBig A_TextTagLight">Из этих фотографий создается обложка эффекта. Минимальный размер фото — 1024×1024</p>
                  </div>
    
                  <div class='С_PhotoGalleryEffectPreview'>
                    <div class='M_PhotoElementPreview'>
                      <%= f.label :image_before, class: "M_PhotoElementLabel" do %>
                        <%= f.file_field :image_before, 
                            accept: "image/*,.gif", 
                            class: "M_PhotoElementInput", 
                            data: { effect_create_target: "inputBefore", action: "change->effect-create#previewImage" },
                            hidden: true %>
                        <div class="M_PhotoElementPreviewImage">
                          <%= image_tag("icon-attachment.svg", alt: "Иконка файла", class: "file-icon", data: { effect_create_target: "outputBefore" }) %>
                        </div>
                      <% end %>
                      <p class='A_TextTag A_TextTagBig A_TextTagLight'>До применения</p>
                    </div>
                    <div class='M_PhotoElementPreview'>
                      <%= f.label :image_after, class: "M_PhotoElementLabel" do %>
                        <%= f.file_field :image_after, 
                            accept: "image/*,.gif", 
                            class: "M_PhotoElementInput", 
                            data: { effect_create_target: "inputAfter", action: "change->effect-create#previewImage" },
                            hidden: true %>
                        <div class="M_PhotoElementPreviewImage">
                          <%= image_tag("icon-attachment.svg", alt: "Иконка файла", class: "file-icon", data: { effect_create_target: "outputAfter" }) %>
                        </div>
                      <% end %>
                      <p class='A_TextTag A_TextTagBig A_TextTagLight'>После применения</p>
                    </div>                    
                  </div>                
                </div>
              </div>
              <div class='O_InstructionInfo' data-effect-create-target="instructionBlock" style="display: none;">
                <div class='M_CollectionForm M_CollectionFormBig'>
                  <p class="A_TextTag A_TextTagBig A_TextTagLight">Объясни, как импортировать эффект в программу или несколько программ. Опиши особенности использования и настройки эффекта</p>
                  <%= f.text_area :manual, 
                  class: 'A_InputForm A_InputFormTextArea A_InputFormTextAreaBig', 
                  placeholder: 'Инструкция по установке и настройке',
                  data: { effect_create_target: "instructionText", action: "input->effect-create#validateCurrentStep" } %>
                </div>
              </div>      
            </div>
            <div class='O_CategoriesInfo' data-effect-create-target="categoriesBlock" style="display: none;">
              <div class='M_CollectionForm M_CollectionFormCategory'>
                <div class="M_CategoriesWrapper">
                  <h3 class="A_Header3">Выбор категории</h3>
                  <%= f.hidden_field :programs, value: "blender" %>
                  <%= f.hidden_field :platform, id: "selected_platform" %>
                  <div class="M_CategoriesContainer">
                    <% Effect::ALLOWED_TAGS.each do |category| %>
                      <div class="M_Choice" data-controller="choice" data-action="click->choice#click">
                        <%= f.label "category_list_#{category}", human_readable_category(category), class: 'A_TextButtonSeсondary A_TextButtonSeсondaryBlack' %>
                        <%= f.radio_button :category_list, category, data: { action: "change->effect-create#validateCurrentStep" } %>
                      </div>
                    <% end %>
                  </div> 
                </div>
              </div>
            </div>
            <div class='O_TagsInfo' data-effect-create-target="tagsBlock" style="display: none;">
              <div class='M_CollectionForm'>
                <div class="O_CreateEffectTagsArea" data-controller="effect-tags">
                  <div class="O_TagsCreateEffect">
                    <h3 class="A_Header3">Теги</h3>
                    
                    <!-- Задачи -->
                    <div class="Q_FilterDropdown">
                      <button class='A_Filter A_FilterCategory A_TextTagBig' type="button" data-action="effect-tags#toggleTasks" data-effect-tags-target="taskToggleButton">
                        Задача
                        <%= image_tag("Q_IconArrowBlack.svg", alt: "Картинка рейтинга", class: "Q_IconArrowBlack") %>
                      </button>
                      
                      <!-- Контейнер для отображения выбранных задач -->
                      <div class="C_SelectedCategories" data-effect-tags-target="selectedTasks" style="display: none;">
                        <div class="Q_SelectedCategoriesList" data-effect-tags-target="selectedTasksList">
                          <!-- Выбранные задачи будут добавляться сюда динамически -->
                        </div>
                      </div>
                      
                      <div class="Q_CategoryDropdown Q_CategoryDropdownScroll" data-effect-tags-target="taskDropdown" style="display: none;">
                        <div class="Q_CategoryList Q_CategoryListScroll">
                          <% TaskHelper::TASK_MAPPINGS.each do |task_key, task_label| %>
                            <label class="Q_CategoryItem custom-checkbox">
                              <span><%= task_label %></span>
                              <%= f.check_box "task_list_#{task_key}", { checked: false, data: { action: "effect-tags#selectTask effect-create#validateCurrentStep" } }, task_key, "" %>
                              <span class="checkmark"></span>
                            </label>
                          <% end %>
                        </div>
                      </div>
                    </div>

                    <!-- Программы -->
                    <div class="Q_FilterDropdown Q_CategoryDropdownScroll">
                      <button class='A_Filter A_FilterCategory A_TextTagBig' type="button" data-action="effect-tags#togglePrograms" data-effect-tags-target="programToggleButton">
                        Программа
                        <%= image_tag("Q_IconArrowBlack.svg", alt: "Картинка рейтинга", class: "Q_IconArrowBlack") %>
                      </button>
                      
                      <!-- Контейнер для отображения выбранных программ -->
                      <div class="C_SelectedCategories" data-effect-tags-target="selectedPrograms" style="display: none;">
                        <div class="Q_SelectedCategoriesList" data-effect-tags-target="selectedProgramsList">
                          <!-- Выбранные программы будут добавляться сюда динамически -->
                        </div>
                      </div>
                      
                      <div class="Q_CategoryDropdown" data-effect-tags-target="programDropdown" style="display: none;">
                        <div class="Q_CategoryList Q_CategoryListScrollProgram">
                          <% [
                            ["photoshop", "Photoshop"],
                            ["lightroom", "Lightroom"],
                            ["after_effects", "After Effects"],
                            ["premiere_pro", "Premiere Pro"],
                            ["blender", "Blender"],
                            ["affinity_photo", "Affinity Photo"],
                            ["capture_one", "Capture One"],
                            ["maya", "Maya"],
                            ["cinema_4d", "Cinema 4D"],
                            ["3ds_max", "3ds Max"],
                            ["zbrush", "ZBrush"],
                            ["unreal", "Unreal Engine"],
                            ["davinci", "DaVinci Resolve"],
                            ["substance", "Substance Painter"],
                            ["protopie", "ProtoPie"],
                            ["krita", "Krita"],
                            ["sketch", "Sketch"],
                            ["animate", "Adobe Animate"],
                            ["figma", "Figma"],
                            ["clip", "Clip Studio Paint"],
                            ["nuke", "Nuke"],
                            ["fc", "Final Cut Pro"],
                            ["procreate", "Procreate"],
                            ["godot", "Godot"],
                            ["lens", "Lens Studio"],
                            ["rive", "Rive"],
                            ["unity", "Unity"],
                            ["spark", "Spark AR"],
                            ["spine", "Spine"],
                            ["toon", "Toon Boom Harmony"]
                          ].each do |program_key, program_label| %>
                            <label class="Q_CategoryItem custom-checkbox">
                              <div class="Q_ProgramItemContent">
                                <%= image_tag(program_icon(program_key), alt: program_label, class: "Q_ProgramIconDropdown") if program_icon(program_key) %>
                                <span><%= program_label %></span>
                              </div>
                              <%= f.check_box "program_list_#{program_key}", { checked: false, data: { action: "effect-tags#selectProgram effect-create#updatePreviewPrograms effect-create#validateCurrentStep" } }, program_key, "" %>
                              <span class="checkmark"></span>
                            </label>
                          <% end %>
                        </div>
                      </div>
                    </div>

                    <!-- Платформы -->
                    <div class="Q_FilterDropdown">
                      <button class='A_Filter A_FilterCategory A_TextTagBig' type="button" data-action="effect-tags#togglePlatforms" data-effect-tags-target="platformToggleButton">
                        Платформа
                        <%= image_tag("Q_IconArrowBlack.svg", alt: "Картинка рейтинга", class: "Q_IconArrowBlack") %>
                      </button>
                      
                      <!-- Контейнер для отображения выбранных платформ -->
                      <div class="C_SelectedCategories" data-effect-tags-target="selectedPlatforms" style="display: none;">
                        <div class="Q_SelectedCategoriesList" data-effect-tags-target="selectedPlatformsList">
                          <!-- Выбранные платформы будут добавляться сюда динамически -->
                        </div>
                      </div>
                      
                      <div class="Q_CategoryDropdown" data-effect-tags-target="platformDropdown" style="display: none;">
                        <div class="Q_CategoryList">
                          <% [
                            ["windows", "Windows"],
                            ["mac", "Mac"]
                          ].each do |platform_key, platform_label| %>
                            <label class="Q_CategoryItem custom-checkbox">
                              <span><%= platform_label %></span>
                              <%= f.check_box "platform_list_#{platform_key}", { checked: false, data: { action: "effect-tags#selectPlatform effect-create#validateCurrentStep" } }, platform_key, "" %>
                              <span class="checkmark"></span>
                            </label>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class='O_LinkPreviewInfo' data-effect-create-target="linkPreviewBlock" style="display: none; width: 100%;">
              <div class='M_CollectionForm M_CollectionFormRow'>
                <div class="C_LinkArea C_LinkAreaRow">
                  <h3 class="A_Header3">Ссылка на скачивание</h3>
                  <p class="A_TextTag A_TextTagBig A_TextTagLight">Добавь действительную ссылку на облако или репозиторий, где можно скачать эффект</p>
                  <div class='W_linkEffect'>
                    <%= f.text_field :link_to, 
                    class: 'A_InputForm A_InputFormLink', 
                    placeholder: "Ссылка", data: { action: "input->effect-create#validateCurrentStep" } %>
                    <%= image_tag("linkIcon.svg", alt: "Картинка рейтинга", class: "Q_linkIcon") %>
                  </div>
                  <p class="A_TextTag A_TextTagBig A_TextTagLight">Твой эффект опубликуется, когда ссылка пройдет проверку модератором — мы пришлем уведомление</p>
                  
                </div>
                <div class='W_PreviewArea'>
                  <h3 class="A_Header3">Превью карточки эффекта</h3>
                  
                  <!-- Превью карточки эффекта -->
                  <div class='O_EffectCard O_EffectCardPreview O_EffectCardPreviewSmall' data-effect-create-target="previewCard">
                    <div class='С_PhotoGalleryEffect С_PhotoGalleryEffectImagesSmall'>
                      <div class="A_PhotoEffect A_PhotoEffectPreview" data-effect-create-target="previewImageBefore">
                        <%= image_tag("icon-attachment.svg", alt: "До применения", class: "file-icon") %>
                        <p class="A_TextTag">До применения</p>
                      </div>
                      <div class="A_PhotoEffect A_PhotoEffectPreview" data-effect-create-target="previewImageAfter">
                        <%= image_tag("icon-attachment.svg", alt: "После применения", class: "file-icon") %>
                        <p class="A_TextTag">После применения</p>
                      </div>
                    </div>

                    <div class='M_TextEffectСard'>
                      <div class='W_TextEffectTopCard'>
                        <p class='A_TextEffectCard' data-effect-create-target="previewName">Название эффекта</p>
                      </div> 
                    </div>
                  </div>

                  <button type="button" class="A_More" data-action="click->effect-create#previewAndCreate">
                    Смотреть превью
                  </button>
                </div>
              </div>
            </div>
            <div class="W_buttonsSaveEffect">
              <%= f.button 'Назад', 
               class: "A_buttonLight", 
               data: { effect_create_target: "backButton", action: "effect-create#previousStep" },
               type: "button",
               style: "display: none;" %>
              <%= f.button 'Далее', 
               class: "A_ButtonPrimary A_ButtonPrimaryMargin", 
               data: { effect_create_target: "nextButton", action: "effect-create#nextStep" },
               type: "button" %>
            </div>
            <%= f.button 'Отправить', 
             class: "A_ButtonPrimary", 
             type: "submit",
             style: "display: none;",
             data: { final_submit: true } %>
          </div>
        </dialog>
      <% end %>
    </div> 
  </div>
</div>
